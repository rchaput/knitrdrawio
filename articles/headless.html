<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="knitrdrawio">
<title>Using headless environments (Docker) • knitrdrawio</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using headless environments (Docker)">
<meta property="og:description" content="knitrdrawio">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">knitrdrawio</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/knitrdrawio.html">Get started</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/headless.html">Using headless environments (Docker)</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rchaput/knitrdrawio/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="headless_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using headless environments (Docker)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rchaput/knitrdrawio/blob/HEAD/vignettes/headless.Rmd" class="external-link"><code>vignettes/headless.Rmd</code></a></small>
      <div class="d-none name"><code>headless.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="motivations">Motivations<a class="anchor" aria-label="anchor" href="#motivations"></a>
</h2>
<p>It feels natural and intuitive to use <strong>knitrdrawio</strong> as part of a Continuous Integration / Continuous Deployment (CI/CD) workflow, for example to automatically your document or book, each time you push a commit.</p>
<p>However, CI/CD typically runs in a <em>headless</em> environment, a server without a graphical display, and/or in Docker containers.</p>
<p><strong>knitrdrawio</strong> requires additional dependencies to work in such environments, because of known limitations of the draw.io executable. Being an Electron-based application, draw.io expects and requires a graphical display, and needs to be tricked into thinking there is one available.</p>
<p><em>Note</em>: if your system is mis-configured, <strong>knitrdrawio</strong> might believe to be in a <em>headless</em> environment, and complain! In this case, you must make sure that your <code>$DISPLAY</code> environment variable is correctly set, so that <strong>knitrdrawio</strong> (and, more importantly, drawio itself) may find your display. In particular, if the <code>$DISPLAY</code> variable is empty, there certainly is a problem.</p>
</div>
<div class="section level2">
<h2 id="how-to">How to<a class="anchor" aria-label="anchor" href="#how-to"></a>
</h2>
<p>Two methods are available:</p>
<ul>
<li>Using the provided Docker image for a simplified experience, at the cost of a large image size.</li>
<li>Manually installing the tools and dependencies to make <em>draw.io</em> work.</li>
</ul>
<div class="section level3">
<h3 id="using-the-provided-docker-image">Using the provided Docker image<a class="anchor" aria-label="anchor" href="#using-the-provided-docker-image"></a>
</h3>
<p><strong>knitrdrawio</strong> provides a complete <a href="https://github.com/rchaput/knitrdrawio/pkgs/container/knitrdrawio" class="external-link">Docker image</a> which already contains all necessary dependencies, such as <em>R</em>, <em>knitr</em>, <em>pandoc</em>, <em>draw.io</em>, etc.</p>
<p>This image is automatically built against the latest release of knitrdrawio, so you can safely use it in your workflows, or reuse it as a base for your own images.</p>
<p>This image can be accessed as <code>ghcr.io/rchaput/knitrdrawio:master</code>, e.g.,</p>
<pre><code>```Dockerfile
FROM ghcr.io/rchaput/knitrdrawio:master
RUN apt install &lt;your-custom-dependencies&gt;
RUN R -e 'rmarkdown::render("your_document.Rmd")'
```</code></pre>
<p><em>Note</em>: this image is inspired from rocker/r-rmd, which includes every dependency for rendering documents, including a TeX distribution (for PDF output). It was meant as a ready-to-use tool, for which you do not have to worry: simply bring your own custom dependencies (if any), and let the image do the job for you. However, this results in a very large image size (several GBs).</p>
</div>
<div class="section level3">
<h3 id="manual-installation">Manual installation<a class="anchor" aria-label="anchor" href="#manual-installation"></a>
</h3>
<p>You may also manually install the dependencies: <strong>knitrdrawio</strong> internally has support for some tools and workarounds to make <em>draw.io</em> work when these tools are available.</p>
<p>First, you need to install on the system the following dependencies:</p>
<ul>
<li>
<a href="https://packages.ubuntu.com/kinetic/xvfb" class="external-link">xvfb</a>: a virtual display server that behaves as if a “true” graphical display was connected. Read more on the <a href="https://linux.die.net/man/1/xvfb" class="external-link">man page</a>.</li>
<li>
<a href="https://packages.ubuntu.com/kinetic/libdrm2" class="external-link">libdrm2</a>, <a href="https://packages.ubuntu.com/kinetic/libgbm1" class="external-link">libgbm1</a>, <a href="https://packages.ubuntu.com/kinetic/libasound2" class="external-link">libasound2</a>: libraries that drawio does not include but requires.</li>
</ul>
<p>These system dependencies can be simply installed through your distribution’s package manager, e.g., <code>apt</code> for Ubuntu and Debian-derivatives systems. Please check with your package manager for the appropriate packages, the name might differ.</p>
<p>Then, you may simply render your document: everything will work, thanks to <strong>knitrdrawio</strong>’s internal detection and workaround.</p>
<p>To summarize, assuming an Ubuntu (or Debian) based environment:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">sudo</span> apt update</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">sudo</span> apt install libdrm2 libgbm1 libasound2 xvfb</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="ex">R</span> -e <span class="st">'rmarkdown::render("your_document.Rmd")'</span></span></code></pre></div>
<div class="section level4">
<h4 id="performance-optimization">Performance optimization<a class="anchor" aria-label="anchor" href="#performance-optimization"></a>
</h4>
<p>However, please note that the previously described steps induce a small overhead: <strong>knitrdrawio</strong> internally relies on <code>xvfb-run</code> to create a “fake” graphical server each time a diagram should be rendered. This process takes an additional time, and, as the number of diagrams in the document increases, the overhead might become noticeable.</p>
<p>To avoid this and optimize for performance, an additional step can be performed, using the same dependencies. This method creates a virtual server before <strong>knitrdrawio</strong> is launched, using the same virtual server for all diagrams. Thus, the overhead of starting a virtual server is paid only once.</p>
<p>To do so, <em>before</em> rendering your document, choose a display number, which must be unique on the machine. Usually, <code>99</code> should work. Set the <code>$DISPLAY</code> environment variable to <code>:&lt;your number&gt;</code>, e.g., <code>export DISPLAY=:99</code> (do not forget the <code>:</code> part). Then, start the virtual server with <code>Xvfb &amp;</code>.</p>
<p>You can now render your document: the virtual server, as a background process, will make <strong>knitrdrawio</strong> (and, ultimately, <em>draw.io</em>) believe there is a graphical server available.</p>
<p>The complete workflow should look like this, assuming an Ubuntu (or Debian) based distribution:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">sudo</span> apt update</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="fu">sudo</span> apt install libdrm2 libgbm1 libasound2 xvfb</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="bu">export</span> <span class="va">DISPLAY=</span>:99</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="ex">Xvfb</span> <span class="kw">&amp;</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="ex">R</span> -e <span class="st">'rmarkdown::render("your_document.Rmd")'</span></span></code></pre></div>
<p>Note that the first two lines (<code>apt update</code> and <code>apt install</code>) are the same as previously, and need to be executed only once. The following two (<code>export DISPLAY</code> and <code>Xvfb &amp;</code>) need to be executed once in a session, i.e., until your close your terminal. Finally, the last line performs the rendering, and can be executed as much as desired. As long as the background process is available, the rendering will work.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="bypassing-the-headless-detection">Bypassing the headless-detection<a class="anchor" aria-label="anchor" href="#bypassing-the-headless-detection"></a>
</h2>
<p>By default, <strong>knitrdrawio</strong> tries to detect whether the current system is headless, by relying on the <code>xrandr</code> tool, or, if it is not available, the <code>$DISPLAY</code> environment variable.</p>
<p>If, for some reason, this detection does not work, or you want to increase performance by avoiding this check every time a chunk is rendered, the detection can be bypassed by setting a global option:</p>
<pre><code>```r
options("knitrdrawio.headless" = FALSE)
```</code></pre>
<p>This option is applied to all subsequent calls to the <strong>knitrdrawio</strong> engine, and should thus be placed as early as possible. A common place for global options is the <code>.Renv</code> file, which is loaded by R at the beginning of a session. Using a <code>.Renv</code> file makes it easy to have different configurations for a local development system versus a CI/CD headless workflow.</p>
<p>The following values are recognized:</p>
<ul>
<li>
<code>NULL</code> (default): perform the headless-detection each time.</li>
<li>
<code>FALSE</code>: assume the system is <em>not</em> headless, do not perform the detection.</li>
<li>
<code>TRUE</code>: assume the system <em>is</em> headless, do not perform the detection, and always apply the “headless workaround” through <code>xvfb</code>.</li>
</ul>
<p><em>Warning</em>: <em>drawio</em> will fail if the system is headless but no workaround, such as <code>xvfb</code>, is set up. You may also use the <code>FALSE</code> value to disable <strong>knitrdrawio</strong>’s built-in workaround, if you prefer to manually set up another one.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by remy chaput.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
